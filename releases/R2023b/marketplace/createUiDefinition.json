{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "basics": [
            {
                "name": "text1",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                    "text": "Need help?",
                    "link": {
                        "label": " Click here for instructions",
                        "uri": "https://www.mathworks.com/help/matlab/matlab_env/run-matlab-from-azure-marketplace.html"
                    }
                }
            }
        ],
        "steps": [
            {
                "name": "VirtualMachineConfig",
                "label": "Virtual Machine Settings",
                "subLabel": {
                    "preValidation": "Configure virtual machine resources and settings",
                    "postValidation": "Done"
                },
                "bladeTitle": "Virtual Machine Settings",
                "elements": [
                    {
                        "name": "vmName",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Virtual Machine name",
                        "toolTip": "Name of the Virtual Machine resource that will be created in the selected resource group.",
                        "defaultValue": "matlab-desktop",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-z0-9A-Z-]{3,79}$",
                            "validationMessage": "VM Name must be between 3 and 79 characters long, and can only contain letters, numbers, and hyphens."
                        }
                    },
                    {
                        "name": "vmSize",
                        "type": "Microsoft.Compute.SizeSelector",
                        "label": "Virtual machine size",
                        "toolTip": "Choose the virtual machine size to provision. The default size is suitable for running MATLAB. Larger sizes can increase costs.",
                        "recommendedSizes": [
                            "Standard_D3_v2"
                        ],
                        "osPlatform": "Linux",
                        "count": "1"
                    },
                    {
                        "name": "adminUsername",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Admin Username",
                        "toolTip": "Admin username for the VM running MATLAB. Must be at least 6 characters long and start with an alphabet. To avoid any deployment errors, please check the list of [disallowed values](https://docs.microsoft.com/en-us/rest/api/compute/virtual-machines/create-or-update?tabs=HTTP#osprofile) for Admin Username.",
                        "defaultValue": "ubuntu",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z]{6,64}$",
                            "validationMessage": "The username must be at least 6 characters long and should start with an alphabet."
                        }
                    },
                    {
                        "name": "adminPassword",
                        "type": "Microsoft.Common.PasswordBox",
                        "label": {
                            "password": "Password",
                            "confirmPassword": "Confirm password"
                        },
                        "toolTip": "Choose the password for the admin user for the instance.",
                        "constraints": {
                            "required": true,
                            "regex": "^((?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])|(?=.*[0-9])(?=.*[a-z])(?=.*[!@#$%^&*])|(?=.*[0-9])(?=.*[A-Z])(?=.*[!@#$%^&*])|(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*])).{12,72}$",
                            "validationMessage": "Password must be at least 12 characters long and have 3 out of the following: one number, one lower case, one upper case, or one special character"
                        },
                        "options": {
                            "hideConfirmation": false
                        },
                        "visible": true
                    },
                    {
                        "name": "clientIPAddresses",
                        "type": "Microsoft.Common.TextBox",
                        "label": "IP addresses",
                        "toolTip": "Client CIDR defining the range of IP addresses permitted to connect to the virtual machine. For example: 192.168.100.14/24",
                        "defaultValue": "",
                        "constraints": {
                            "required": true,
                            "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$",
                            "validationMessage": "Address must use valid CIDR notation. For example: 192.168.100.14/24"
                        }
                    },
                    {
                        "name": "autoShutdown",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Auto-shutdown",
                        "defaultValue": "Never",
                        "toolTip": "Select the duration after which the VM should be automatically shut down post launch.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Never",
                                    "value": "Never"
                                },
                                {
                                    "label": "After 1 hour",
                                    "value": "After 1 hour"
                                },
                                {
                                    "label": "After 2 hours",
                                    "value": "After 2 hours"
                                },
                                {
                                    "label": "After 3 hours",
                                    "value": "After 3 hours"
                                },
                                {
                                    "label": "After 4 hours",
                                    "value": "After 4 hours"
                                },
                                {
                                    "label": "After 5 hours",
                                    "value": "After 5 hours"
                                },
                                {
                                    "label": "After 6 hours",
                                    "value": "After 6 hours"
                                },
                                {
                                    "label": "After 7 hours",
                                    "value": "After 7 hours"
                                },
                                {
                                    "label": "After 8 hours",
                                    "value": "After 8 hours"
                                },
                                {
                                    "label": "After 9 hours",
                                    "value": "After 9 hours"
                                },
                                {
                                    "label": "After 10 hours",
                                    "value": "After 10 hours"
                                },
                                {
                                    "label": "After 11 hours",
                                    "value": "After 11 hours"
                                },
                                {
                                    "label": "After 12 hours",
                                    "value": "After 12 hours"
                                },
                                {
                                    "label": "After 13 hours",
                                    "value": "After 13 hours"
                                },
                                {
                                    "label": "After 14 hours",
                                    "value": "After 14 hours"
                                },
                                {
                                    "label": "After 15 hours",
                                    "value": "After 15 hours"
                                },
                                {
                                    "label": "After 16 hours",
                                    "value": "After 16 hours"
                                },
                                {
                                    "label": "After 17 hours",
                                    "value": "After 17 hours"
                                },
                                {
                                    "label": "After 18 hours",
                                    "value": "After 18 hours"
                                },
                                {
                                    "label": "After 19 hours",
                                    "value": "After 19 hours"
                                },
                                {
                                    "label": "After 20 hours",
                                    "value": "After 20 hours"
                                },
                                {
                                    "label": "After 21 hours",
                                    "value": "After 21 hours"
                                },
                                {
                                    "label": "After 22 hours",
                                    "value": "After 22 hours"
                                },
                                {
                                    "label": "After 23 hours",
                                    "value": "After 23 hours"
                                },
                                {
                                    "label": "After 24 hours",
                                    "value": "After 24 hours"
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "accessProtocol",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Access Protocol",
                        "defaultValue": "RDP",
                        "toolTip": "Access protocol to connect to this VM. Selecting 'NICE DCV' will configure [NICE DCV](https://aws.amazon.com/hpc/dcv/) using a 30-days demo license (unless a production license is provided). You can access the desktop on a browser using the NICE DCV connection URL in the Outputs section of the deployment page once the resource group is successfully deployed. By using NICE DCV, you agree to the terms and conditions outlined in [NICE DCV End User License Agreement](https://www.nice-dcv.com/eula.html). If you select 'RDP', NICE DCV will not be configured, and you can connect to this VM using a RDP connection.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "RDP",
                                    "value": "RDP"
                                },
                                {
                                    "label": "NICE DCV",
                                    "value": "NICE DCV"
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "niceDCVLicenseServer",
                        "type": "Microsoft.Common.TextBox",
                        "label": "NICE DCV License server (Optional)",
                        "defaultValue": "",
                        "toolTip": "If you have opted to enable NICE DCV and have a production license, use this optional parameter to specify the NICE DCV license server's port and hostname (or IP address) in the form of port@hostname. This field must be left blank if you have opted not to enable NICE DCV or want to use NICE DCV with a demo license.",
                        "constraints": {
                            "required": false,
                            "regex": "^[1-9][0-9]{0,4}@[0-9.a-zA-Z]+$",
                            "validationMessage": "Port number must be followed by a valid ip address."
                        },
                        "visible": true
                    },
                    {
                        "name": "MATLABLicenseServer",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Network License Manager for MATLAB (Optional)",
                        "defaultValue": "",
                        "toolTip": "Port and hostname or IP address of the virtual machine hosting your Network License Manager for MATLAB.  For example: 27001@10.0.0.1.",
                        "constraints": {
                            "required": false,
                            "regex": "^[1-9][0-9]{0,4}@[0-9.a-zA-Z]+$",
                            "validationMessage": "Port number must be followed by a valid ip address."
                        },
                        "visible": true
                    },
                    {
                        "name": "optionalUserCommand",
                        "type": "Microsoft.Common.TextBox",
                        "label": "User Command (Optional)",
                        "defaultValue": "",
                        "toolTip": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AZURE, use this command excluding the angle brackets: &lt;echo -e \"export CLOUD=AZURE\" &#124; sudo tee -a /etc/profile.d/setenvvar.sh && source /etc/profile&gt;. To run an external script, use this command excluding the angle brackets: &lt;wget -O /tmp/my-script.sh \"https://example.com/script.sh\" && bash /tmp/my-script.sh&gt;. Find the logs at '/var/log/mathworks/startup.log'.",
                        "constraints": {
                            "required": false,
                            "regex": "^.{0,4000}$",
                            "validationMessage": "The total length should not exceed 4,000 characters."
                        },
                        "visible": true
                    },
                    
                    {
                        "name": "text1",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": true,
                        "options": {
                            "icon": "Info",
                            "text": "Click here for more information about the Network License Manager for MATLAB on mathworks.com.",
                            "uri": "https://www.mathworks.com/help/licensingoncloud/matlab-on-the-cloud.html"
                        }
                    },
                    {
                        "name": "text2",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "Need help?",
                            "link": {
                                "label": " Click here for instructions",
                                "uri": "https://www.mathworks.com/help/matlab/matlab_env/run-matlab-from-azure-marketplace.html"
                            }
                        }
                    }
                ]
            },
            {
                "name": "networking",
                "label": "Networking",
                "subLabel": {
                    "preValidation": "Configure virtual network resources and settings",
                    "postValidation": "Done"
                },
                "bladeTitle": "Virtual Network",
                "elements": [
                    {
                        "name": "virtualNetwork",
                        "type": "Microsoft.Network.VirtualNetworkCombo",
                        "label": {
                            "virtualNetwork": "Virtual network",
                            "subnets": "Subnets"
                        },
                        "toolTip": {
                            "virtualNetwork": "Name of the Virtual Network resource to use. By default a new resource is created and added to the resource group.",
                            "subnets": "A subnet is a range of IP addresses in your virtual network, which can be used to isolate virtual machines from each other or from the Internet."
                        },
                        "defaultValue": {
                            "name": "vnet01",
                            "addressPrefixSize": "/16"
                        },
                        "constraints": {
                            "minAddressPrefixSize": "/16"
                        },
                        "options": {
                            "hideExisting": false
                        },
                        "subnets": {
                            "subnet1": {
                                "label": "Subnet",
                                "defaultValue": {
                                    "name": "subnet-1",
                                    "addressPrefixSize": "/24"
                                },
                                "constraints": {
                                    "minAddressPrefixSize": "/24",
                                    "minAddressCount": 12,
                                    "requireContiguousAddresses": true
                                }
                            }
                        },
                        "visible": true
                    },
                    {
                        "name": "publicIpAddress",
                        "type": "Microsoft.Network.PublicIpAddressCombo",
                        "label": {
                            "publicIpAddress": "Public IP Address for the VM",
                            "domainNameLabel": "DNS Prefix for the Public IP Address"
                        },
                        "toolTip": {
                            "publicIpAddress": "Name of the Public IP Address resource to use. By default a new resource is created and added to the resource group.",
                            "domainNameLabel": "Globally unique DNS Prefix for the public IP address. You will need to use the full DNS name of the virtual machine to connect to it with Remote Desktop."
                        },
                        "defaultValue": {
                            "publicIpAddressName": "[concat(steps('VirtualMachineConfig').vmName, '-ip')]",
                            "domainNameLabel": "[concat(steps('VirtualMachineConfig').vmName, '-', take(replace(guid(), '-', ''), 10))]"
                        },
                        "options": {
                            "hideExisting": false,
                            "hideNone": false
                        },
                        "constraints": {
                            "required": {
                                "domainNameLabel": true
                            }
                        }
                    },
                    {
                        "name": "text3",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "Need help?",
                            "link": {
                                "label": " Click here for instructions",
                                "uri": "https://www.mathworks.com/help/matlab/matlab_env/run-matlab-from-azure-marketplace.html"
                            }
                        }
                    }
                ]
            }
        ],
        "outputs": {
            "location": "[location()]",
            "vmName": "[steps('VirtualMachineConfig').vmName]",
            "adminUsername": "[steps('VirtualMachineConfig').adminUsername]",
            "adminPassword": "[steps('VirtualMachineConfig').adminPassword]",
            "vmSize": "[steps('VirtualMachineConfig').vmSize]",
            "clientIPAddresses": "[steps('VirtualMachineConfig').clientIPAddresses]",
            "newOrExistingVirtualNetwork": "[steps('networking').virtualNetwork.newOrExisting]",
            "virtualNetworkName": "[steps('networking').virtualNetwork.name]",
            "addressPrefixes": "[steps('networking').virtualNetwork.addressPrefixes]",
            "subnetName": "[steps('networking').virtualNetwork.subnets.subnet1.name]",
            "subnetPrefix": "[steps('networking').virtualNetwork.subnets.subnet1.addressPrefix]",
            "virtualNetworkResourceGroupName": "[steps('networking').virtualNetwork.resourceGroup]",
            "publicIpNewOrExisting": "[steps('networking').publicIpAddress.newOrExistingOrNone]",
            "publicIpName": "[steps('networking').publicIpAddress.name]",
            "publicIpDns": "[steps('networking').publicIpAddress.domainNameLabel]",
            "publicIpResourceGroupName": "[steps('networking').publicIpAddress.resourceGroup]",
            "publicIPAllocationMethod": "[steps('networking').publicIpAddress.publicIPAllocationMethod]",
            "publicIpSku": "[steps('networking').publicIpAddress.sku]",
            "MATLABLicenseServer": "[steps('VirtualMachineConfig').MATLABLicenseServer]",
            "autoShutdown": "[steps('VirtualMachineConfig').autoShutdown]",
            "accessProtocol": "[steps('VirtualMachineConfig').accessProtocol]",
            "niceDCVLicenseServer": "[steps('VirtualMachineConfig').niceDCVLicenseServer]",
            "optionalUserCommand": "[steps('VirtualMachineConfig').optionalUserCommand]"
        }
    }
}
